<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>理解AES加密解密的使用方法 | 个人主页</title>
    <meta name="description" content="眭镇涛的博客">
    <link rel="icon" href="/img/logo.ico">
  <link rel="manifest" href="/manifest.json">
    
    <link rel="preload" href="/assets/css/0.styles.d570e400.css" as="style"><link rel="preload" href="/assets/js/app.08b6b1fe.js" as="script"><link rel="preload" href="/assets/js/2.3ae0fcbf.js" as="script"><link rel="preload" href="/assets/js/5.9edaf6d3.js" as="script"><link rel="prefetch" href="/assets/js/10.7ac56634.js"><link rel="prefetch" href="/assets/js/11.b7ea0b1a.js"><link rel="prefetch" href="/assets/js/3.ef9b9872.js"><link rel="prefetch" href="/assets/js/4.554ed953.js"><link rel="prefetch" href="/assets/js/6.fc23171a.js"><link rel="prefetch" href="/assets/js/7.20a39aa2.js"><link rel="prefetch" href="/assets/js/8.e5aff1f7.js"><link rel="prefetch" href="/assets/js/9.b67092df.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d570e400.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/ffmpeg问题.html" class="sidebar-link">FFmpeg添加视频内嵌字幕提示“Could not create a libass track when reading file”</a></li><li><a href="/wireshark没有接口.html" class="sidebar-link">wireshark找不到接口的处理方法</a></li><li><a href="/AES加密算法使用.html" class="active sidebar-link">理解AES加密解密的使用方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/AES加密算法使用.html#nodejs实现" class="sidebar-link">Nodejs实现</a></li><li class="sidebar-sub-header"><a href="/AES加密算法使用.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/js打包问题.html" class="sidebar-link">快速重现被打包的javascrpt代码</a></li><li><a href="/终端快捷键.html" class="sidebar-link">Ubuntu终端常用的快捷键</a></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="理解aes加密解密的使用方法"><a href="#理解aes加密解密的使用方法" aria-hidden="true" class="header-anchor">#</a> 理解AES加密解密的使用方法</h1> <blockquote><p>很多人对于AES加密并不是很了解，导致互相之间进行加密解密困难。<br>
本文用简单的方式来介绍AES在使用上需要的知识，而不涉及内部算法。最后给出例子来帮助理解AES加密解密的使用方法。</p></blockquote> <h3 id="aes的麻烦"><a href="#aes的麻烦" aria-hidden="true" class="header-anchor">#</a> AES的麻烦</h3> <ul><li>相比于其他加密，AES加密似乎模式很多，包括ECB、CBC等等等等，每个模式又包括IV参数和Padding参数，并且，不同语言对AES加密的库设计有区别。这些导致AES加密在不同人之间联调会很麻烦。</li></ul> <h3 id="aes属于块加密"><a href="#aes属于块加密" aria-hidden="true" class="header-anchor">#</a> AES属于块加密</h3> <ul><li>不难理解，对越长的字符串进行加密，代价越大，所以通常对明文进行分段，然后对每段明文进行加密，最后再拼成一个字符串。块加密的一个要面临的问题就是如何填满最后一块？所以这就是PADDING的作用，使用各种方式填满最后一块字符串，所以对于解密端，也需要用同样的PADDING来找到最后一块中的真实数据的长度。</li></ul> <h3 id="加密模式"><a href="#加密模式" aria-hidden="true" class="header-anchor">#</a> 加密模式</h3> <ul><li>AES分为几种模式，比如ECB，CBC，CFB等等，这些模式除了ECB由于没有使用IV而不太安全，其他模式差别并没有太明显，大部分的区别在IV和KEY来计算密文的方法略有区别。具体可参考<a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation" target="_blank" rel="noopener noreferrer">WIKI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的说明。</li> <li>另外，AES分为AES128，AES256等，表示期待秘钥的长度，比如AES256秘钥的长度应该是256/8的32字节，一些语言的库会进行自动截取，让人以为任何长度的秘钥都可以。而这其实是有区别的。</li></ul> <h3 id="iv的作用"><a href="#iv的作用" aria-hidden="true" class="header-anchor">#</a> IV的作用</h3> <ul><li>IV称为初始向量，不同的IV加密后的字符串是不同的，加密和解密需要相同的IV，既然IV看起来和key一样，却还要多一个IV的目的，对于每个块来说，key是不变的，但是只有第一个块的IV是用户提供的，其他块IV都是自动生成。</li> <li>IV的长度为16字节。超过或者不足，可能实现的库都会进行补齐或截断。但是由于块的长度是16字节，所以一般可以认为需要的IV是16字节。</li></ul> <h3 id="padding"><a href="#padding" aria-hidden="true" class="header-anchor">#</a> PADDING</h3> <ul><li>AES块加密说过，PADDING是用来填充最后一块使得变成一整块，所以对于加密解密两端需要使用同一的PADDING模式，大部分PADDING模式为PKCS5, PKCS7, NOPADDING。</li></ul> <h3 id="加密解密端"><a href="#加密解密端" aria-hidden="true" class="header-anchor">#</a> 加密解密端</h3> <ul><li>所以，在设计AES加密的时候：
   - 对于加密端，应该包括：加密秘钥长度，秘钥，IV值，加密模式，PADDING方式。
   - 对于解密端，应该包括：解密秘钥长度，秘钥，IV值，解密模式，PADDING方式。</li></ul> <h2 id="nodejs实现"><a href="#nodejs实现" aria-hidden="true" class="header-anchor">#</a> Nodejs实现</h2> <ul><li>这里使用Nodejs的cryptojs库模拟AES加密解密</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;crypto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> algorithm<span class="token operator">=</span><span class="token string">'aes-256-cbc'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">&quot;aaaabbbbccccddddeeeeffffgggghhhh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">&quot;1234567812345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> cipher<span class="token operator">=</span>crypto<span class="token punctuation">.</span><span class="token function">createCipheriv</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> cipher<span class="token operator">=</span>crypto<span class="token punctuation">.</span><span class="token function">createDecipheriv</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> text<span class="token operator">=</span><span class="token string">&quot;ni你好hao&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> encoded<span class="token operator">=</span><span class="token function">encrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>结果如下</li></ul> <blockquote><p>WfH4hzIc3dc0pjxa9V/RgQ==<br>
ni你好hao</p></blockquote> <ul><li>nodejs自带的并不能自动配置padding等参数，演示起来并不方便</li> <li>于是使用另一个框架crypto-js的nodejs库实现和之前完全相同的版本</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> CryptoJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;crypto-js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> key <span class="token operator">=</span><span class="token string">&quot;aaaabbbbccccddddeeeeffffgggghhhh&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> iv <span class="token operator">=</span> <span class="token string">&quot;1234567812345678&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> CryptoJS<span class="token punctuation">.</span><span class="token constant">AES</span><span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span>CryptoJS<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        iv<span class="token punctuation">:</span>CryptoJS<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span>CryptoJS<span class="token punctuation">.</span>mode<span class="token punctuation">.</span><span class="token constant">CBC</span><span class="token punctuation">,</span>
        padding<span class="token punctuation">:</span>CryptoJS<span class="token punctuation">.</span>pad<span class="token punctuation">.</span>Pkcs7
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> CryptoJS<span class="token punctuation">.</span><span class="token constant">AES</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span>CryptoJS<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        iv<span class="token punctuation">:</span>CryptoJS<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span>
        mode<span class="token punctuation">:</span>CryptoJS<span class="token punctuation">.</span>mode<span class="token punctuation">.</span><span class="token constant">CBC</span><span class="token punctuation">,</span>
        padding<span class="token punctuation">:</span>CryptoJS<span class="token punctuation">.</span>pad<span class="token punctuation">.</span>Pkcs7
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>CryptoJS<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> text<span class="token operator">=</span><span class="token string">&quot;ni你好hao&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> encoded<span class="token operator">=</span><span class="token function">encrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>encoded<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>现在aes的参数都变成可配置的，接下来验证一下之前对AES的理解。
<ul><li>改变IV的长度，发现当IV大于16字节的时候，不管16字节之后的是什么，都不影响加密结果，应该是种自动截取机制(nodejs原生库IV不是16字节，就会报错）</li> <li>改变IV的长度，当IV小于16字节，还可以成功加密，可能是自动补齐机制</li> <li>加密IV和解密IV不同的时候，并不影响解密是否成功，但是解密的结果有差别，比如将解密的IV变成1234567813345678，则解密结果变为ni你好h`o</li> <li>修改padding，加密解密的padding换成NoPadding，发现解密之后生成utf8字符串出错</li> <li>经过多次尝试，加密为Pkcs7和ZeroPadding时，加密后的字符串变化显著，这时解密用任何padding模式，都可以成功解密。</li></ul></li> <li>ni你好hao，经过Pkcs7后，输出为</li></ul> <blockquote><p>WfH4hzIc3dc0pjxa9V/RgQ==</p></blockquote> <ul><li>nopadding后，输出为</li></ul> <blockquote><p>OtSNypfx1SF6C2E=</p></blockquote> <ul><li>zeropadding后，输出为</li></ul> <blockquote><p>OtSNypfx1SF6C2GfyXMidA==</p></blockquote> <ul><li>Pkcs7的结果和其他结果相差很大，很难相信其padding是补充最后一块</li> <li>有趣的是Pkcs7的结果和zeropadding的结果通过同样的解密设置，能解出同样的字符串ni你好hao</li></ul> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <ol><li>AES加密解密的秘钥有一对，一个是IV一个是KEY，并且他们的长度都有严格要求。</li> <li>Padding的作用似乎不只是补齐最后，如果自己什么都对，但是加密失败，可以尝试不同Padding。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/wireshark没有接口.html" class="prev">
          wireshark找不到接口的处理方法
        </a></span> <span class="next"><a href="/js打包问题.html">
          快速重现被打包的javascrpt代码
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.08b6b1fe.js" defer></script><script src="/assets/js/2.3ae0fcbf.js" defer></script><script src="/assets/js/5.9edaf6d3.js" defer></script>
  </body>
</html>
